name: "Docker Build & Push"
description: "Builds a Docker image and pushes it to a container registry"
inputs:
  app:
    description: "Application to build"
    required: true
  dockerfile:
    description: "Dockerfile to build"
    required: false
    default: "Dockerfile"
  dockerignore_override:
    description: "Override default .dockerignore file from context"
    required: false
  context:
    description: "Docker build context"
    required: false
    default: "."
  tag:
    description: "Docker image tag"
    required: false
    default: "${{ github.sha }}"
  directory:
    description: "Directory to change into before building"
    required: false
    default: "."
  args:
    description: "Additional 'docker build' arguments"
    required: false
    default: ""
  registry_address:
    description: "Container registry address"
    required: true
  registry_username:
    description: "Container registry username"
    required: true
  registry_password:
    description: "Container registry password"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      shell: bash
      run: |
        cd "${{ inputs.directory }}"

        if [ -n "${{ inputs.dockerignore_override }}" ]; then
          cp "${{ inputs.context }}/.dockerignore" "${{ inputs.context }}/.dockerignore.bak"
          cp "${{ inputs.dockerignore_override }}" "${{ inputs.context }}/.dockerignore"
        fi

        docker buildx build \
          --tag ${{ inputs.registry_address }}/${{ inputs.app }}:${{ inputs.tag }} \
          --file ${{ inputs.dockerfile }} \
          ${{ inputs.context }} \
          ${{ inputs.args }}

        if [ -n "${{ inputs.dockerignore_override }}" ]; then
          mv "${{ inputs.context }}/.dockerignore.bak" "${{ inputs.context }}/.dockerignore"
        fi

    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry_address }}
        username: ${{ inputs.registry_username }}
        password: ${{ inputs.registry_password }}
        logout: false

    - name: Push image to registry
      shell: bash
      run: docker push "${{ inputs.registry_address }}/${{ inputs.app }}:${{ inputs.tag }}"
